---
title: "ADA final project"
author: "Pinqing"
date: "`r Sys.Date()`"
output: html_document
---

# Introduction

This project will use the LLCP2021.XPT dataset to ask and answer two questions:\
1. Is smoking status associated with the risk of diabetes?\
2. Does sex modify the association between smoking status and the risk of diabetes?

# Load packages and open libraries

```{r, echo=TRUE, message = F}
pacman::p_load(odds.n.ends, blorr, lmtest, car, broom, tidyverse, readr, jtools, table1, DiagrammeR, rsvg, VIM, mice, lattice, dplyr, ggplot2, haven) 
```

# Import SAS XPT file

```{r, echo=TRUE}
BRFSS <- read_xpt('/Users/tangpinqing/Desktop/08:24-05:26/fall 2025/Advanced Data Analysis/project/LLCP2021.XPT ')
```

# Select variables we will need

```{r}
BRFSS <- BRFSS %>%
  select(c("_SMOKER3", "DIABETE4", "_AGE_G", "_SEX", "_EDUCAG", "_INCOMG1", "_TOTINDA"))

head(BRFSS)
```

# Provide new names for variables

```{r}
names(BRFSS) <- c("smoker", "diabetes", "agegroup", "sex", "education", "income", "exercise")
colnames(BRFSS)
```

# Look at variable summaries to understand NAs

```{r}
summary(BRFSS)
```

# Recoding variables for analysis

## Drop people who only have diabetes during pregnancy

```{r}
BRFSS1 <- BRFSS %>%
  filter(!(diabetes == 2))

nrow(BRFSS)-nrow(BRFSS1)
```

## Diabetes as binary

```{r}
table(BRFSS1$diabetes)

BRFSS1 <- BRFSS1 %>%
  mutate(diabetes_bi = case_when(diabetes %in% c(3, 4) ~ 0,
                                 diabetes == 1 ~ 1,
                                 diabetes %in% c(7, 9) ~ NA,
                                 TRUE ~ NA),
         diabetes_bi = factor(diabetes_bi, levels=c(0:1), labels=c("No", "Yes"))) # make it a factor variable

# check to make sure re-categorization worked as expected
table(BRFSS1$diabetes, BRFSS1$diabetes_bi, useNA="always")
```

## Code a four level smokers variable as everyday_smoker, someday_smoker, former_smoker, nonsmoker

```{r}
table(BRFSS1$smoker)

BRFSS1 <- BRFSS1 %>%
  mutate(smoker_cat = case_when(smoker == 4 ~ 0,
                                smoker == 3 ~ 1,
                                smoker == 2 ~ 2,
                                smoker == 1 ~ 3,
                                smoker == 9 ~ NA),
         smoker_cat = factor(smoker_cat, levels=c(0:3), labels=c("nonsmoker", "former_smoker", "someday_smoker", 
                                                                 "everyday_smoker")))

# check to make sure re-categorization worked as expected
table(BRFSS1$smoker, BRFSS1$smoker_cat, useNA="always")
```

## Code a three level age variable as less than 44, 45 to 64, ≥65.

```{r}
table(BRFSS1$agegroup)

BRFSS1 <- BRFSS1 %>%
  mutate(age_3L = case_when(agegroup %in% c(1, 2, 3) ~ 0,
                            agegroup %in% c(4, 5) ~ 1,
                            agegroup == 6 ~ 2),
         age_3L = factor(age_3L, levels=c(0:2), labels=c("18-44", "45-64", ">=65")))

table(BRFSS1$agegroup, BRFSS1$age_3L, useNA="always")
table(BRFSS1$age_3L)
```

## Recode SEX

```{r}
BRFSS1 <- BRFSS1 %>%
  mutate(sex_f=factor(sex, levels=c(1:2), labels=c("Male", "Female")))

table(BRFSS1$sex_f, useNA = "always")
```

## Recode education

```{r}
BRFSS1 <- BRFSS1 %>%
  mutate(education = ifelse(education == 9, NA, education), 
         education_f = factor(education, levels=c(1:4), labels=c("Did not graduate high school", "Graduated high school", "Attended college or technical school", "Graduated from college or technical school")))

table(BRFSS1$education, BRFSS1$education_f, useNA="always")
```

## Code a three level income variable as less than 35K, 35 to \<100K, ≥100K.

```{r}
table(BRFSS1$income)

BRFSS1 <- BRFSS1 %>%
  mutate(income_3L = case_when(income %in% c(1:3) ~ 0,
                               income %in% c(4, 5) ~ 1,
                               income %in% c(6, 7) ~ 2,
                               income == 9 ~ NA),
         income_3L = factor(income_3L, 0:2, c("low income", "middle income", "high income"))) 

# checking to make sure the recode worked
table(BRFSS1$income, BRFSS1$income_3L, useNA = "always")
```

## Exercise as binary

```{r}
table(BRFSS1$exercise)

BRFSS1 <- BRFSS1 %>%
  mutate(exercise_bi = case_when(exercise == 2 ~ 0,
                                 exercise == 1 ~ 1,
                                 exercise == 9 ~ NA),
         exercise_bi = factor(exercise_bi, levels=c(0:1), labels=c("No", "Yes"))) 

# check to make sure re-categorization worked as expected
table(BRFSS1$exercise, BRFSS1$exercise_bi, useNA="always")
```

# Drop NAs for anyone with missing values on smoker and diabetes in BRFSS included in analysis

```{r}
BRFSS_ex1 <- BRFSS1 %>%
  drop_na(diabetes_bi)
nrow(BRFSS1)-nrow(BRFSS_ex1)

BRFSS_ex <- BRFSS_ex1 %>%
  drop_na(smoker_cat)
nrow(BRFSS_ex1)-nrow(BRFSS_ex)
```

# Check number and percentage of data excluded.

```{r}
nrow(BRFSS)-nrow(BRFSS_ex)
100 - nrow(BRFSS_ex)/nrow(BRFSS) * 100
```

# Let's use the grViz function from the DiagrammeR package to make a flow chart of how we arrived at our analytic dataframe (figure 1)

```{r}
figure1 <- grViz(diagram = "digraph flowchart{ 

      node [fontname = Helvetica, shape = rectangle, fontsize = 15] 
      
      node1 [label = '@@1'] 
      node2 [label = '@@2'] 
      node3 [label = '@@3']
      node4 [label = '@@4'] 
      
      node1 -> node2 -> node3 -> node4
}
      [1]: 'BRFSS 2021 Respondents Aged ≥18 year n = 438,693'
      [2]: 'Excluding 3,811 individuals with diabetes only during pregnancy n = 434,882'
      [3]: 'Excluding 982 individuals with missing data on diabetes n = 433,900'
      [4]: 'Excluding 24,551 individuals with missing data on smoking status n = 409,349'
      ")
```

## export figure 1

```{r}
figure1 %>%
   DiagrammeRsvg::export_svg() %>% # convert to SVG format
   charToRaw() %>% # converts SVG text string into binary format
   rsvg::rsvg_pdf("Figure 1.pdf") # the output file is named as "Figure 1"
```

# DAG

![](dagitty-model.png)\

Therefore, the minimal sufficient adjustment sets of covariates to estimate the **total effect** of `smoking` on `diabetes` are age, sex, and income.

# Check number and percentage of missing values in income_3L

```{r}
sum(is.na(BRFSS_ex$income_3L))                  
mean(is.na(BRFSS_ex$income_3L)) * 100 
```

# Addressing missing values on income_3L by multiple imputation

## Run missing indicator model to identify whether income_3L is MAR

```{r}
BRFSS_ex$income_missing <- ifelse(is.na(BRFSS_ex$income_3L), 1, 0)

model_miss <- glm(income_missing ~ age_3L + sex_f + education_f + smoker_cat + diabetes_bi,
                  family = binomial,
                  data = BRFSS_ex)

summary(model_miss)
```

## Select variables for imputation

```{r}
vars_for_mi <- BRFSS_ex %>%
  select(diabetes_bi, smoker_cat, age_3L, sex_f, income_3L, education_f)
```

## Imputing data with the mice function from the MICE package

```{r}
imp <- mice(vars_for_mi, # dataframe
            m = 5, # number of imputations, 5 is default,  5-10 is usually enough but some set it to the number of variables being imputed. 
            maxit = 5, # number of imputations got get the imputation model to converge. The default is 5
            seed = 1000000) # set so that everytime you run this code you get the same imputation datasets. Number is arbitrary
imp
```

## Diagnostics for imputation model: Are the imputed values plausible?

```{r}
imp$imp$income_3L
```

## Let's look at the imputed compared to the non-imputed data to see how the distributions compare using density plot

```{r}
figure2 <- densityplot(imp, ~ income_3L,
                       main = "Figure 3. Observed vs Imputed Distribution of income levels",
                       xlab = "Income levels",
                       scales = list(
                                     x = list(
                                              at = c(1,2,3),                       # factor 的三个位置
                                              labels = c("Low", "Middle", "High")  # 你真正想显示的文字
                                              )
                                    ),
                       auto.key = list(space = "top",
                                       columns = 2,
                                       points = FALSE,
                                       lines = TRUE,
                                       text = c("Observed", "Imputed")
  ))
figure2

# The imputed income values appeared plausible. The distribution of imputed categories closely matched the observed data, suggesting that the imputation model performed well.
```

## Export figure 2

```{r}
png("density_income3.png", width = 2000, height = 1500, res = 300)
print(figure2)
dev.off()
```

# Creating a Table 1 using the table1 function with the first imputed dataset

```{r}
imp1 <- mice::complete(data=imp, action=1)

label(imp1$age_3L) <- "Age (years)"
label(imp1$sex_f) <- "Sex"
label(imp1$income_3L) <- "Income level"
label(imp1$education_f) <- "Education level"
label(imp1$diabetes_bi) <- "Diabetes status"
label(imp1$smoker_cat) <- "Smoking status"

tab1 <- table1(~ age_3L + sex_f + income_3L + education_f + diabetes_bi|smoker_cat, overall = "Total", rowlabelhead = "Variable", imp1) 
tab1
```

## Save table 1

```{r}
pacman::p_load(table1, htmltools)
save_html(tab1, file = "Table1.html")
```

# Run a univariable (unadjusted) logistic model.

```{r}
fit_unadj <- with(imp, glm(diabetes_bi ~ smoker_cat, family = binomial))

unadj_pool <- pool(fit_unadj)
summary(unadj_pool)

summary(unadj_pool, conf.int = TRUE, exponentiate = TRUE)
```

# Unadjusted model does not include variables need to be imputed, so run a normal logistic regression to check whether the coefficients are same.

```{r}
model1<- glm(diabetes_bi ~ smoker_cat, data=BRFSS_ex, family="binomial")
summary(model1) 
```

# Run an adjusted logistic model.

```{r}
fit_adj <- with(imp, glm(diabetes_bi ~ smoker_cat + age_3L + sex_f + income_3L, family = binomial))

adj_pool <- pool(fit_adj)
summary(adj_pool)

summary(adj_pool, conf.int = TRUE, exponentiate = TRUE)
```

# Code for applying the Wald-test and lr test to the imputed datasets to see if confounders improves model fit.

```{r}
D1(fit_adj, fit_unadj)
D3(fit_adj, fit_unadj)
```

# Asumptions test (if only use one of the imputed dataset)

## Run unadjusted and adjusted logistic regression model using the first imputed dataset

```{r}
# Unadjusted model (imp1)
model_unadj_imp1 <- glm(diabetes_bi ~ smoker_cat,
                        data = imp1,
                        family = binomial)

# Adjusted model (imp1) —— 相当于老师的 model4
model_adj_imp1 <- glm(diabetes_bi ~ smoker_cat + age_3L + sex_f + income_3L,
                      data = imp1,
                      family = binomial)

summary(model_unadj_imp1)
summary(model_adj_imp1)
```

## Look at assumptions of multicollinearity using the vif function from the car package

```{r}
vif(model_adj_imp1)
```

## Lets look for influential observations using Cook's distance.

```{r}
plot(model_adj_imp1, which = 4, id.n = 3, col="red") 

model_adj_imp1_data <- augment(model_adj_imp1) %>%
  mutate(index = 1:n())

head(model_adj_imp1_data)

# define cutoff variable as 1
cutoff1 <- 1

BRFSS_in <- model_adj_imp1_data %>%
  filter(.cooksd < cutoff1)

nrow(BRFSS_in) / nrow(imp1) # no observations are excluded

# define cutoff variable as 4 / n
cutoff2 <- 4 / nrow(imp1)

BRFSS_in2 <- model_adj_imp1_data %>%
  filter(.cooksd < cutoff2)

nrow(BRFSS_in2) / nrow(imp1)
1-nrow(BRFSS_in2) / nrow(imp1)
```

## check our variables by diabetes_binary in models with and without influential points

```{r}
# Model without influential points
table(BRFSS_in2$smoker_cat, BRFSS_in2$diabetes_bi)
# Model with influrntial points
table(imp1$smoker_cat, imp1$diabetes_bi)
```

Only exclude people with daibetes, inducing selection bias. Therefore, I tend not to exclude influential points.

# EMM: Does sex modify the association between smoking status and the risk of diabetes?

## Using the LR test that whether sex modifies the association between smoking and diabetes.
```{r}
# Model with interaction term smoker_cat * sex_f
fit_int <- with(imp, glm(diabetes_bi ~ smoker_cat + age_3L + sex_f + income_3L + smoker_cat * sex_f, family = binomial))

# Test the hypothesis with the lrtest
D1(fit_int, fit_adj)

# The interaction term is significant via the LR test
```
## Run models stratified by sex.

### Male
```{r}
# unadjusted 
fit_male_unadj <- with(imp, glm(diabetes_bi ~ smoker_cat, family = binomial,
                                subset = (sex_f == "Male")))

pool_male_unadj <- pool(fit_male_unadj)
summary(pool_male_unadj, exponentiate = TRUE, conf.int = TRUE)

# adjusted
fit_male_adj <- with(imp, glm(diabetes_bi ~ smoker_cat + age_3L + income_3L, family = binomial,
                              subset = (sex_f == "Male")))

pool_male_adj <- pool(fit_male_adj)
summary(pool_male_adj, exponentiate = TRUE, conf.int = TRUE)
```

### Female
```{r}
# unadjusted 
fit_female_unadj <- with(imp, glm(diabetes_bi ~ smoker_cat, family = binomial,
                                subset = (sex_f == "Female")))

pool_female_unadj <- pool(fit_female_unadj)
summary(pool_female_unadj, exponentiate = TRUE, conf.int = TRUE)

# adjusted
fit_female_adj <- with(imp, glm(diabetes_bi ~ smoker_cat + age_3L + income_3L, family = binomial,
                              subset = (sex_f == "Female")))

pool_female_adj <- pool(fit_female_adj)
summary(pool_female_adj, exponentiate = TRUE, conf.int = TRUE)
```






















